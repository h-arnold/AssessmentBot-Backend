# Stage 6: LLM and Prompt Abstraction Test Cases

This document lists comprehensive test scenarios for Stage 6, which introduces abstractions for the LLM service and prompt generation. All tests should be implemented using Jest, mocking dependencies where appropriate to ensure focused unit tests.

---

## 1. LLMService Interface (Consumer Tests)

These tests validate that a consumer of the `LLMService` (e.g., `AssessorService`) interacts with the interface correctly. The `LLMService` itself will be mocked.

- **Correct Interaction**
  - The consumer service calls `llmService.send` exactly once with the correct payload generated by the `PromptFactory`.
  - The consumer service correctly returns the mocked response (e.g., `{ score: 5 }`) provided by the `llmService.send` mock.

- **Error Handling**
  - The consumer service gracefully handles errors thrown by `llmService.send`.
  - The consumer service logs the error and throws a new, user-friendly exception.

---

## 2. GeminiService (LLM Implementation)

These tests validate the concrete `GeminiService` implementation. The `@google/genai` SDK will be mocked.

- **Initialisation**
  - The `ConfigService.get` method is called with `'GEMINI_API_KEY'`.
  - The `GoogleGenerativeAI` constructor is called with the API key retrieved from the `ConfigService`.

- **Payload Handling**
  - Correctly selects the `	gemini-2.0-flash-lite` model for simple text payloads.
  - Correctly selects the `gemini-2.5-flash` model for multimodal payloads containing images.
  - Sends a correctly formatted `GenerateContentRequest` for a simple text payload.
  - Sends a correctly formatted `GenerateContentRequest` for a multimodal payload, with a `parts` array containing both text and base64 image data.

- **Robustness and Error Handling**
  - Successfully parses a malformed JSON string from the LLM's response by using the `jsonrepair` utility.
  - Logs and throws a user-friendly `Error` ("Failed to get a valid response from the LLM.") when the underlying SDK call fails.

---

## 3. Prompt Base Class

These tests validate the constructor and Zod validation logic of the abstract `Prompt` base class.

- **Input Validation**
  - Successfully parses a valid input object containing `referenceTask`, `studentTask`, and `emptyTask` as strings.
  - Accepts empty strings as valid input for all properties.
  - Throws a `ZodError` if the `referenceTask` property is missing.
  - Throws a `ZodError` if the `studentTask` property is not a string (e.g., a number).
  - Throws a `ZodError` if the `emptyTask` property is missing.

---

## 4. PromptFactory

These tests validate the logic for creating prompt instances.

- **Instance Creation**
  - Returns an instance of `TextPrompt` when the DTO's `taskType` is `'TEXT'`.
  - Returns an instance of `TablePrompt` when the DTO's `taskType` is `'TABLE'`.
  - Returns an instance of `ImagePrompt` when the DTO's `taskType` is `'IMAGE'`.

- **Data Integrity**
  - The created prompt instance has its `referenceTask`, `studentTask`, and `emptyTask` properties correctly populated from the DTO.

- **Error Handling**
  - Throws an `Error` with the message "Unsupported task type" if the `taskType` is not one of the supported values.

---

## 5. TextPrompt Subclass

These tests validate the message generation for text-based tasks. `fs/promises.readFile` will be mocked.

- **Message Building**
  - Correctly reads the `textPrompt.md` template.
  - Returns a final string where `{referenceTask}`, `{studentTask}`, and `{emptyTask}` placeholders are correctly replaced with the input data.

---

## 6. TablePrompt Subclass

These tests validate the message generation for table-based tasks. `fs/promises.readFile` will be mocked.

- **Message Building**
  - Correctly reads the `tablePrompt.md` template.
  - Returns a final string where the markdown table data is correctly embedded in the prompt.

---

## 7. ImagePrompt Subclass

These tests validate the payload generation for image-based tasks. `fs/promises.readFile` will be mocked to provide both the template and fake image data.

- **Payload Building**
  - Correctly reads the `imagePrompt.md` template.
  - Correctly reads the image files specified in the input.
  - Builds a structured payload object containing a `messages` array (with the rendered text) and an `images` array.
  - The `images` array in the payload contains the correct base64 data and mime type for each image.
  - Handles multiple images correctly, ensuring all are included in the final payload.
